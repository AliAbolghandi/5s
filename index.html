<!DOCTYPE html>
<html lang="fa">
<head>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <meta charset="UTF-8">
  <title>ورود / ثبت‌نام</title>
  <style>
    body { font-family: sans-serif; direction: rtl; padding: 20px; }
    .tab { margin: 10px; padding: 10px 20px; cursor: pointer; border-radius: 5px; display: inline-block; }
    .active { background: #007bff; color: white; }
    .form { display: none; margin-top: 20px; }
    .form input { display: block; margin: 10px 0; padding: 10px; width: 250px; }
    .btn { padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .btn:hover { background: #218838; }
    #loading { display: none; margin: 20px 0; }
    #loading img { width: 50px; }
    .error { color: red; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>ورود یا ثبت‌نام</h2>
  <div>
    <span class="tab active" onclick="showTab('register')">ثبت‌نام</span>
    <span class="tab" onclick="showTab('login')">ورود</span>
  </div>

  <!-- ثبت نام -->
  <div id="register" class="form" style="display:block;">
    <input type="text" id="reg_name" placeholder="نام">
    <input type="text" id="reg_family" placeholder="نام خانوادگی">
    <input type="text" id="reg_phone" placeholder="شماره همراه">
    <input type="password" id="reg_pass" placeholder="رمز عبور (حداقل ۸ کاراکتر)">
    <button class="btn" onclick="registerUser()">ثبت‌نام</button>
    <div id="reg_error" class="error"></div>
  </div>

  <!-- ورود -->
  <div id="login" class="form">
    <input type="text" id="login_phone" placeholder="شماره همراه">
    <input type="password" id="login_pass" placeholder="رمز عبور">
    <button class="btn" onclick="loginUser()">ورود</button>
    <div id="loading"><img src="https://i.gifer.com/ZZ5H.gif"></div>
    <div id="login_error" class="error"></div>
  </div>

  <script>
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQGnfFdjRNgOIbFaYbfLhgyi0Inoo9VeEWIVvqMpk40pa18yjvcOjJauu3SZTHVHhUIQMN0TGSWBHh0/pub?gid=282182097&single=true&output=csv";
    const scriptUrl = "YOUR_WEBAPP_URL"; // آدرس Web App که توی Google Apps Script ساختی

    let users = [];

    // سوئیچ بین تب‌ها
    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove("active"));
      document.querySelectorAll('.form').forEach(f => f.style.display = "none");
      document.getElementById(tab).style.display = "block";
      document.querySelector(`.tab[onclick="showTab('${tab}')"]`).classList.add("active");
    }

    // بارگذاری یوزرها از شیت
    async function loadUsers() {
      const res = await fetch(sheetUrl);
      const text = await res.text();
      const delimiter = text.includes(";") ? ";" : ",";
      const rows = text.split("\n").slice(1); // حذف هدر
      users = rows.map(r => r.split(delimiter).map(c => c.trim()));
      console.log("📌 Users loaded from sheet:", users); // لاگ کامل همه کاربرا
    }

    // ثبت نام
    async function registerUser() {
      const name = document.getElementById("reg_name").value.trim();
      const family = document.getElementById("reg_family").value.trim();
      const phone = document.getElementById("reg_phone").value.trim();
      const pass = document.getElementById("reg_pass").value.trim();
      const errorDiv = document.getElementById("reg_error");

      if (!name || !family || !phone || !pass) {
        errorDiv.textContent = "همه فیلدها الزامی هستند.";
        return;
      }
      if (pass.length < 8) {
        errorDiv.textContent = "رمز عبور باید حداقل ۸ کاراکتر باشد.";
        return;
      }

      // ارسال داده به Web App
      try {
        await fetch(scriptUrl, {
          method: "POST",
          body: JSON.stringify({ firstName: name, lastName: family, phone, password: pass }),
          headers: { "Content-Type": "application/json" }
        });
        alert("ثبت‌نام با موفقیت انجام شد. حالا می‌توانید وارد شوید.");
        showTab("login");
      } catch (e) {
        errorDiv.textContent = "خطا در ارتباط با سرور.";
      }
    }

    // ورود
    async function loginUser() {
      const phone = document.getElementById("login_phone").value.trim();
      const pass = document.getElementById("login_pass").value.trim();
      const errorDiv = document.getElementById("login_error");
      const loader = document.getElementById("loading");

      errorDiv.textContent = "";
      loader.style.display = "block";

      await loadUsers();

      setTimeout(() => {
        loader.style.display = "none";

        // بررسی همه ردیف‌ها
        let user = null;
        for (let i = 0; i < users.length; i++) {
          console.log("🔍 Checking row:", users[i]);
          if (
            users[i][2] && users[i][2].trim() === phone &&
            users[i][3] && users[i][3].trim() === pass
          ) {
            user = users[i];
            break;
          }
        }

        if (user) {
          alert("ورود موفق ✅");
          window.location.href = "assessment.html";
        } else {
          errorDiv.textContent = "شماره همراه یا رمز عبور اشتباه است.";
        }
      }, 1500);
    }

    loadUsers();
  </script>
</body>
</html>
