<!DOCTYPE html>
<html lang="fa">
<head>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <meta charset="UTF-8">
  <title>ÙˆØ±ÙˆØ¯ / Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</title>
  <style>
    body { font-family: sans-serif; direction: rtl; padding: 20px; }
    .tab { margin: 10px; padding: 10px 20px; cursor: pointer; border-radius: 5px; display: inline-block; }
    .active { background: #007bff; color: white; }
    .form { display: none; margin-top: 20px; }
    .form input { display: block; margin: 10px 0; padding: 10px; width: 250px; }
    .btn { padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .btn:hover { background: #218838; }
    #loading { display: none; margin: 20px 0; }
    #loading img { width: 50px; }
    .error { color: red; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>ÙˆØ±ÙˆØ¯ ÛŒØ§ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</h2>
  <div>
    <span class="tab active" onclick="showTab('register')">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</span>
    <span class="tab" onclick="showTab('login')">ÙˆØ±ÙˆØ¯</span>
  </div>

  <!-- Ø«Ø¨Øª Ù†Ø§Ù… -->
  <div id="register" class="form" style="display:block;">
    <input type="text" id="reg_name" placeholder="Ù†Ø§Ù…">
    <input type="text" id="reg_family" placeholder="Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ">
    <input type="text" id="reg_phone" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡">
    <input type="password" id="reg_pass" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± (Ø­Ø¯Ø§Ù‚Ù„ Û¸ Ú©Ø§Ø±Ø§Ú©ØªØ±)">
    <button class="btn" onclick="registerUser()">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
    <div id="reg_error" class="error"></div>
  </div>

  <!-- ÙˆØ±ÙˆØ¯ -->
  <div id="login" class="form">
    <input type="text" id="login_phone" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡">
    <input type="password" id="login_pass" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
    <button class="btn" onclick="loginUser()">ÙˆØ±ÙˆØ¯</button>
    <div id="loading"><img src="https://i.gifer.com/ZZ5H.gif"></div>
    <div id="login_error" class="error"></div>
  </div>

  <script>
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQGnfFdjRNgOIbFaYbfLhgyi0Inoo9VeEWIVvqMpk40pa18yjvcOjJauu3SZTHVHhUIQMN0TGSWBHh0/pub?gid=282182097&single=true&output=csv";
    const scriptUrl = "YOUR_WEBAPP_URL"; // Ø¢Ø¯Ø±Ø³ Web App Ú©Ù‡ ØªÙˆÛŒ Google Apps Script Ø³Ø§Ø®ØªÛŒ

    let users = [];

    // Ø³ÙˆØ¦ÛŒÚ† Ø¨ÛŒÙ† ØªØ¨â€ŒÙ‡Ø§
    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove("active"));
      document.querySelectorAll('.form').forEach(f => f.style.display = "none");
      document.getElementById(tab).style.display = "block";
      document.querySelector(`.tab[onclick="showTab('${tab}')"]`).classList.add("active");
    }

    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÛŒÙˆØ²Ø±Ù‡Ø§ Ø§Ø² Ø´ÛŒØª
    async function loadUsers() {
      const res = await fetch(sheetUrl);
      const text = await res.text();
      const delimiter = text.includes(";") ? ";" : ",";
      const rows = text.split("\n").slice(1); // Ø­Ø°Ù Ù‡Ø¯Ø±
      users = rows.map(r => r.split(delimiter).map(c => c.trim()));
      console.log("ğŸ“Œ Users loaded from sheet:", users); // Ù„Ø§Ú¯ Ú©Ø§Ù…Ù„ Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§
    }

    // Ø«Ø¨Øª Ù†Ø§Ù…
    async function registerUser() {
      const name = document.getElementById("reg_name").value.trim();
      const family = document.getElementById("reg_family").value.trim();
      const phone = document.getElementById("reg_phone").value.trim();
      const pass = document.getElementById("reg_pass").value.trim();
      const errorDiv = document.getElementById("reg_error");

      if (!name || !family || !phone || !pass) {
        errorDiv.textContent = "Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø§Ù„Ø²Ø§Ù…ÛŒ Ù‡Ø³ØªÙ†Ø¯.";
        return;
      }
      if (pass.length < 8) {
        errorDiv.textContent = "Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Û¸ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯.";
        return;
      }

      // Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø¯Ù‡ Ø¨Ù‡ Web App
      try {
        await fetch(scriptUrl, {
          method: "POST",
          body: JSON.stringify({ firstName: name, lastName: family, phone, password: pass }),
          headers: { "Content-Type": "application/json" }
        });
        alert("Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯. Ø­Ø§Ù„Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.");
        showTab("login");
      } catch (e) {
        errorDiv.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±.";
      }
    }

    // ÙˆØ±ÙˆØ¯
    async function loginUser() {
      const phone = document.getElementById("login_phone").value.trim();
      const pass = document.getElementById("login_pass").value.trim();
      const errorDiv = document.getElementById("login_error");
      const loader = document.getElementById("loading");

      errorDiv.textContent = "";
      loader.style.display = "block";

      await loadUsers();

      setTimeout(() => {
        loader.style.display = "none";

        // Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ù…Ù‡ Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§
        let user = null;
        for (let i = 0; i < users.length; i++) {
          console.log("ğŸ” Checking row:", users[i]);
          if (
            users[i][2] && users[i][2].trim() === phone &&
            users[i][3] && users[i][3].trim() === pass
          ) {
            user = users[i];
            break;
          }
        }

        if (user) {
          alert("ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ âœ…");
          window.location.href = "assessment.html";
        } else {
          errorDiv.textContent = "Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.";
        }
      }, 1500);
    }

    loadUsers();
  </script>
</body>
</html>
