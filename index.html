<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="utf-8">
  <title>ÙˆØ±ÙˆØ¯ / Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta charset="UTF-8">
  <title>ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</title>
  <style>
    body { font-family: sans-serif; direction: rtl; padding: 20px; }
    .tab { margin: 10px; padding: 10px 20px; cursor: pointer; border-radius: 5px; display: inline-block; }
    .active { background: #007bff; color: white; }
    .form { display: none; margin-top: 20px; }
    .form input { display: block; margin: 10px 0; padding: 10px; width: 250px; }
    .btn { padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .btn:hover { background: #218838; }
    #loading { display: none; margin: 20px 0; }
    #loading img { width: 50px; }
    .error { color: red; margin-top: 10px; }
    .debug { margin-top: 15px; font-size: 12px; color: #555; white-space: pre-wrap; background:#f3f3f3; padding:10px; border-radius:6px; }
    body {
      font-family: sans-serif;
      direction: rtl;
      margin: 20px;
    }
    .form-box {
      max-width: 350px;
      margin: 80px auto;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    input {
      width: 100%;
      margin: 10px 0;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      width: 100%;
      padding: 10px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #2980b9;
    }
    .error {
      color: red;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>ÙˆØ±ÙˆØ¯ ÛŒØ§ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</h2>
  <div>
    <span class="tab active" onclick="showTab('register')">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</span>
    <span class="tab" onclick="showTab('login')">ÙˆØ±ÙˆØ¯</span>
  <div class="form-box">
    <h2>ÙˆØ±ÙˆØ¯</h2>
    <input type="text" id="phone" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„">
    <input type="text" id="name" placeholder="Ù†Ø§Ù…">
    <input type="text" id="family" placeholder="Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ">
    <button onclick="login()">ÙˆØ±ÙˆØ¯</button>
    <div id="error-msg" class="error"></div>
  </div>

  <div id="register" class="form" style="display:block;">
    <input type="text" id="reg_name" placeholder="Ù†Ø§Ù…">
    <input type="text" id="reg_family" placeholder="Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ">
    <input type="text" id="reg_phone" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡">
    <input type="password" id="reg_pass" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± (Ø­Ø¯Ø§Ù‚Ù„ Û¸ Ú©Ø§Ø±Ø§Ú©ØªØ±)">
    <button class="btn" onclick="registerUser()">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
    <div id="reg_error" class="error"></div>
  </div>

  <div id="login" class="form">
    <input type="text" id="login_phone" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡">
    <input type="password" id="login_pass" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
    <button class="btn" onclick="loginUser()">ÙˆØ±ÙˆØ¯</button>
    <div id="loading"><img src="https://i.gifer.com/ZZ5H.gif" alt="loading"></div>
    <div id="login_error" class="error"></div>
  </div>

  <div id="debugBox" class="debug" style="display:none;"></div>

  <script>
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQGnfFdjRNgOIbFaYbfLhgyi0Inoo9VeEWIVvqMpk40pa18yjvcOjJauu3SZTHVHhUIQMN0TGSWBHh0/pub?gid=282182097&single=true&output=csv";
    const scriptUrl = "YOUR_WEBAPP_URL"; // Ø¢Ø¯Ø±Ø³ Web App (Ø§Ú¯Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯)
    const SCRIPT_URL = "ğŸ”— Ø§ÛŒÙ†Ø¬Ø§ Ù„ÛŒÙ†Ú© Google Apps Script Ø®ÙˆØ¯Øª Ø±Ùˆ Ø¨Ø°Ø§Ø±"; 

    let users = []; // Ø¢Ø±Ø§ÛŒÙ‡ Ø¢Ø¨Ø¬Ú©Øªâ€ŒÙ‡Ø§
    function login() {
      const phone = document.getElementById("phone").value.trim();
      const name = document.getElementById("name").value.trim();
      const family = document.getElementById("family").value.trim();
      const errorDiv = document.getElementById("error-msg");

    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove("active"));
      document.querySelectorAll('.form').forEach(f => f.style.display = "none");
      document.getElementById(tab).style.display = "block";
      document.querySelector(`.tab[onclick="showTab('${tab}')"]`).classList.add("active");
    }

    function debug(msg) {
      console.log(msg);
      const el = document.getElementById('debugBox');
      el.style.display = 'block';
      el.textContent += msg + "\n";
    }

    async function loadUsers() {
      try {
        const res = await fetch(sheetUrl);
        const text = await res.text();
        // trim and normalize
        const trimmed = text.replace(/\r/g, '').trim();
        if (!trimmed) {
          debug("âš ï¸ Ø´ÛŒØª Ø®Ø§Ù„ÛŒ Ø§Ø³Øª ÛŒØ§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ CSV Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯.");
          users = [];
          return;
        }
        const delimiter = trimmed.includes(";") ? ";" : ",";
        const lines = trimmed.split("\n").filter(Boolean);
        const rawHeaders = lines[0].replace(/^\uFEFF/, ''); // remove BOM
        const headers = rawHeaders.split(delimiter).map(h => h.trim());
        users = lines.slice(1).map(line => {
          const cols = line.split(delimiter).map(c => c.trim());
          const obj = {};
          headers.forEach((h, i) => obj[h || `col${i}`] = cols[i] || "");
          // keep also array form for backward compatibility
          obj._cols = cols;
          return obj;
        });
        debug(`âœ… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ø² Ø´ÛŒØª: ${users.length} Ø±Ø¯ÛŒÙ`);
        debug("Headers: " + JSON.stringify(headers));
        debug("Ù†Ù…ÙˆÙ†Ù‡ Ø±Ø¯ÛŒÙ Ø§ÙˆÙ„: " + (users[0] ? JSON.stringify(users[0]) : "Ù†Ø¯Ø§Ø±Ø¯"));
      } catch (e) {
        console.error(e);
        debug("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´ÛŒØª: " + e.message);
        users = [];
      }
    }

    async function registerUser() {
      const name = document.getElementById("reg_name").value.trim();
      const family = document.getElementById("reg_family").value.trim();
      const phone = document.getElementById("reg_phone").value.trim();
      const pass = document.getElementById("reg_pass").value.trim();
      const errorDiv = document.getElementById("reg_error");

      errorDiv.textContent = "";
      if (!name || !family || !phone || !pass) {
        errorDiv.textContent = "Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø§Ù„Ø²Ø§Ù…ÛŒ Ù‡Ø³ØªÙ†Ø¯.";
        return;
      }
      if (pass.length < 8) {
        errorDiv.textContent = "Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Û¸ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯.";
      if (!phone || !name || !family) {
        errorDiv.textContent = "Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯.";
        return;
      }

      try {
        // Ø§Ú¯Ø± WebApp Ø¯Ø§Ø±ÛŒØ¯ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ØŒ ÙˆÚ¯Ø±Ù†Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¯Ø± Ù…Ø±Ø­Ù„Ù‡ Ø§ÙˆÙ„ Ø§ÛŒÙ† Ø±Ø§ ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯.
        if (scriptUrl && scriptUrl !== "YOUR_WEBAPP_URL") {
          await fetch(scriptUrl, {
            method: "POST",
            body: JSON.stringify({ firstName: name, lastName: family, phone, password: pass }),
            headers: { "Content-Type": "application/json" }
          });
        } else {
          debug("â„¹ï¸ Ø¢Ø¯Ø±Ø³ WebApp ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡. Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¯Ø± Ø´ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯Ø› ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø§Ø² Ø´Ù…Ø§ Ø§Ø¬Ø§Ø²Ù‡ Ú¯Ø±ÙØª.");
        }
        alert("Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯. Ø­Ø§Ù„Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.");
        showTab("login");
      } catch (e) {
        console.error(e);
        errorDiv.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±.";
      }
    }

    function anyCellMatches(rowObj, value) {
      if (!value) return false;
      value = value.trim();
      // check all fields (including _cols array)
      for (const k in rowObj) {
        if (k === "_cols") continue;
        if ((rowObj[k] || "").toString().trim() === value) return true;
      }
      if (Array.isArray(rowObj._cols)) {
        for (const c of rowObj._cols) if ((c||"").toString().trim() === value) return true;
      }
      return false;
    }

    function pickFieldFromRow(rowObj, candidates) {
      const keys = Object.keys(rowObj).filter(k => k !== "_cols");
      for (const cand of candidates) {
        const foundKey = keys.find(k => k.toLowerCase().includes(cand));
        if (foundKey) return rowObj[foundKey] || "";
      }
      // fallback: return first non-empty value
      for (const k of keys) {
        if (rowObj[k]) return rowObj[k];
      }
      // fallback to first col
      return (rowObj._cols && rowObj._cols[0]) || "";
    }
      fetch(SCRIPT_URL + "?action=getUsers")
        .then(res => res.json())
        .then(data => {
          console.log("ğŸ“Œ users:", data);

    async function loginUser() {
      const phone = document.getElementById("login_phone").value.trim();
      const pass = document.getElementById("login_pass").value.trim();
      const errorDiv = document.getElementById("login_error");
      const loader = document.getElementById("loading");
      errorDiv.textContent = "";
          const user = data.find(u =>
            u.phone === phone && u.name === name && u.family === family
          );

      loader.style.display = "block";
      await loadUsers(); // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¬Ø¯ÛŒØ¯ Ù‚Ø¨Ù„ Ø§Ø² Ø¬Ø³ØªØ¬Ùˆ
          if (user) {
            // Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± localStorage
            localStorage.setItem("user", JSON.stringify(user));

      // Ú©ÙˆØªØ§Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ¬Ø±Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ
      setTimeout(() => {
        loader.style.display = "none";

        let matched = null;
        for (const r of users) {
          if (anyCellMatches(r, phone) && anyCellMatches(r, pass)) {
            matched = r;
            break;
            // Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ ÙØ±Ù… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ
            window.location.href = "assessment.html";
          } else {
            errorDiv.textContent = "Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ù…Ø´Ø®ØµØ§Øª ÛŒØ§ÙØª Ù†Ø´Ø¯.";
          }
        }

        if (!matched) {
          debug(`ğŸ” Ú©Ø§Ø±Ø¨Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ ØªØ·Ø¨ÛŒÙ‚ Ø´Ù…Ø§Ø±Ù‡=${phone} Ùˆ Ø±Ù…Ø²=****`);
          errorDiv.textContent = "Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.";
          return;
        }

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¨Ù‡ Ø´Ú©Ù„ÛŒ Ù…Ù‚Ø§ÙˆÙ…
        const name = pickFieldFromRow(matched, ['name','Ù†Ø§Ù…','first','firstname','fname']);
        const family = pickFieldFromRow(matched, ['family','Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ','last','lastname','lname']);
        const phoneVal = pickFieldFromRow(matched, ['phone','mobile','Ø´Ù…Ø§Ø±Ù‡','Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡','tel']);

        const userData = {
          name: (name || "").toString(),
          family: (family || "").toString(),
          phone: (phoneVal || phone).toString(),
          _raw: matched
        };

        debug("ğŸ‘¤ ÛŒØ§ÙØª Ø´Ø¯ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø¯Ø± localStorage: " + JSON.stringify(userData));
        try {
          localStorage.setItem("user", JSON.stringify(userData));
        } catch (e) {
          debug("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ localStorage: " + e.message);
        }

        // Ú©Ù…ÛŒ ØªØ£Ø®ÛŒØ± Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† (localStorage Ø³ÛŒÙ†Ú© Ø§Ø³Øª Ø§Ù…Ø§ Ø¨Ø±Ø§ÛŒ UI Ø¨Ù‡ØªØ±)
        setTimeout(() => {
          window.location.href = "assessment.html";
        }, 250);

      }, 500);
        })
        .catch(err => {
          console.error("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§:", err);
          // Ù‚Ø¨Ù„Ø§Ù‹ alert Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒØ´Ø¯ â†’ Ø§Ù„Ø§Ù† ÙÙ‚Ø· Ù„Ø§Ú¯ Ù…ÛŒØ´Ù‡
          errorDiv.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.";
        });
    }

    // Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ù„Ø§Ú¯ÛŒÙ† Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ù‡ØŒ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø±ÙˆØ¯ Ø¨Ù‡ ÙØ±Ù… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ
    (function redirectIfAlready() {
      try {
        const existing = localStorage.getItem('user');
        if (existing) {
          console.log('ğŸ‘€ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± localStorage ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ assessment.html');
          // Ø§Ú¯Ø± Ø®ÙˆØ§Ø³ØªÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø± Ù…Ù†ØªÙ‚Ù„ Ø´ÙˆØ¯ØŒ uncomment Ú©Ù†ÛŒØ¯:
          // window.location.href = 'assessment.html';
        }
      } catch(e){}
    })();

    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù¾Ø± Ú©Ø±Ø¯Ù† debug)
    loadUsers();
  </script>
</body>
</html>
