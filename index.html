<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>ارزیابی کارخانه</title>
  <style>
    body { font-family: sans-serif; direction: rtl; padding: 20px; }
    .btn { margin: 5px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .btn:hover { background: #0056b3; }
    .question { margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
    input[type="number"] { width: 60px; padding: 5px; font-size: 16px; text-align: center; }
    #result { margin-top: 20px; font-weight: bold; }
    #popup {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); justify-content: center; align-items: center;
    }
    #popup .content {
      background: white; padding: 20px; border-radius: 10px; width: 80%; max-height: 80%; overflow-y: auto;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 8px; text-align: center; }
  </style>
</head>
<body>
  <h2>انتخاب کارخانه</h2>
  <div id="factory-container"></div>
  <div id="area-container"></div>
  <div id="questions-container"></div>

  <!-- popup -->
  <div id="popup">
    <div class="content">
      <h3>پیش‌نمایش ارزیابی</h3>
      <div id="summary"></div>
      <button class="btn" onclick="finalSubmit()">ثبت نهایی ارزیابی</button>
      <button class="btn" onclick="closePopup()">انصراف</button>
    </div>
  </div>

  <script>
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQGnfFdjRNgOIbFaYbfLhgyi0Inoo9VeEWIVvqMpk40pa18yjvcOjJauu3SZTHVHhUIQMN0TGSWBHh0/pub?gid=0&single=true&output=csv";
    let data = [];
    let selectedFactory = "";
    let selectedArea = "";

    async function loadData() {
      const res = await fetch(sheetUrl);
      const text = await res.text();
      const delimiter = text.includes(";") ? ";" : ",";
      const rows = text.split("\n").slice(1);
      data = rows.map(r => r.split(delimiter).map(cell => cell.trim()));
      renderFactories();
    }

    function renderFactories() {
      const container = document.getElementById("factory-container");
      container.innerHTML = "";
      const factories = [...new Set(data.map(r => r[0]).filter(f => f))];
      factories.forEach(factory => {
        const btn = document.createElement("button");
        btn.className = "btn";
        btn.textContent = factory;
        btn.onclick = () => {
          selectedFactory = factory;
          renderAreas(factory);
        };
        container.appendChild(btn);
      });
    }

    function renderAreas(factory) {
      const container = document.getElementById("area-container");
      const qContainer = document.getElementById("questions-container");
      qContainer.innerHTML = "";
      container.innerHTML = `<h3>ناحیه‌های کارخانه «${factory}»</h3>`;
      const areas = [...new Set(data.filter(r => r[0] === factory).map(r => r[1]).filter(a => a))];
      areas.forEach(area => {
        const btn = document.createElement("button");
        btn.className = "btn";
        btn.textContent = area;
        btn.onclick = () => {
          selectedArea = area;
          renderQuestions(factory, area);
        };
        container.appendChild(btn);
      });
    }

    function renderQuestions(factory, area) {
      const container = document.getElementById("questions-container");
      container.innerHTML = `<h3>سوالات ${area} - ${factory}</h3>`;
      const questions = data.filter(r => r[0] === factory && r[1] === area);
      questions.forEach((row, index) => {
        const qDiv = document.createElement("div");
        qDiv.className = "question";
        qDiv.innerHTML = `
          <p>${row[4]} (وزن: ${row[5]})</p>
          <input type="number" min="0" max="5" data-weight="${row[5]}" data-question="${row[4]}"
                 oninput="nextFocus(this, ${index})">
        `;
        container.appendChild(qDiv);
      });

      container.innerHTML += `
        <div id="result">جمع امتیاز واحد: 0</div>
        <button class="btn" onclick="showPopup()">ثبت ارزیابی</button>
      `;
    }

    function nextFocus(input, index) {
      if (input.value !== "" && (input.value < 0 || input.value > 5)) {
        alert("عدد باید بین ۰ تا ۵ باشد");
        input.value = "";
        return;
      }
      updateResult();

      const inputs = document.querySelectorAll("#questions-container input");
      if (input.value !== "" && index + 1 < inputs.length) {
        inputs[index + 1].focus();
      }
    }

    function updateResult() {
      const inputs = document.querySelectorAll("#questions-container input");
      let total = 0;
      inputs.forEach(inp => {
        const val = parseFloat(inp.value) || 0;
        const w = parseFloat(inp.dataset.weight) || 1;
        total += (val * w) / 5;
      });
      document.getElementById("result").textContent = "جمع امتیاز واحد: " + total.toFixed(2);
    }

    function showPopup() {
      const inputs = document.querySelectorAll("#questions-container input");
      let html = "<table><tr><th>سوال</th><th>امتیاز</th></tr>";
      inputs.forEach(inp => {
        html += `<tr><td>${inp.dataset.question}</td><td>${inp.value || "-"}</td></tr>`;
      });
      html += "</table>";
      html += `<p><strong>${document.getElementById("result").textContent}</strong></p>`;
      document.getElementById("summary").innerHTML = html;
      document.getElementById("popup").style.display = "flex";
    }

    function closePopup() {
      document.getElementById("popup").style.display = "none";
    }

    function finalSubmit() {
      alert("داده‌ها ثبت شدند (فعلاً فقط تست محلی).");
      closePopup();
    }

    loadData();
  </script>
</body>
</html>
